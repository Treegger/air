<?xml version="1.0" encoding="utf-8"?>
<s:Window 
	xmlns:fx="http://ns.adobe.com/mxml/2009"
	xmlns:s="library://ns.adobe.com/flex/spark"
	xmlns:mx="library://ns.adobe.com/flex/mx"
	transparent="false"
	systemChrome="standard"
	title="Preferences"
	maximizable="false"
	resizable="false"
	type="normal"
	showStatusBar="false"
	creationComplete="creationCompleteHandler(event)"
	height="200" width="320"
	>
	
	<fx:Metadata>
		[ResourceBundle("airim")]
	</fx:Metadata>

	<fx:Script>
		<![CDATA[
			import com.treegger.airim.controller.ChatController;
			import com.treegger.airim.controller.ChatEvent;
			import com.treegger.airim.controller.PreferencesController;
			import com.treegger.airim.model.UserAccount;
			import com.treegger.airim.model.UserPreference;
			import com.treegger.protobuf.AuthenticateResponse;
			import com.treegger.util.FileSerializer;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			

			
			[Inject]
			public var chatController:ChatController;

			[Inject]
			public var preferenceController:PreferencesController;
			
			[Bindable]
			private var userAccount:UserAccount;
			
			[Bindable]
			private var userPreference:UserPreference;
			
			private var accountChanged:Boolean=false;
			
			private function creationCompleteHandler(event:Event):void
			{
				userAccount = preferenceController.userAccount;
				if( !userAccount ) userAccount = new UserAccount();
				userPreference = preferenceController.userPreference;
			}
			
			private function saveHandler( event:Event):void
			{
				userPreference.startAtLogin = startAtLoginInput.selected;
				NativeApplication.nativeApplication.startAtLogin = userPreference.startAtLogin; 
				preferenceController.userPreference = userPreference;

				
				userAccount.socialNetwork = socialNetworkInput.selectedItem;
				userAccount.username = usernameInput.text;
				userAccount.password = passwordInput.text
				
				
				if( accountChanged )
				{
					currentState = "disabled";
					chatController.addEventListener( ChatEvent.AUTHENTICATION, authenticationHandler );
					chatController.authenticate( userAccount );
				}
				else
				{
					close();
				}
			}
			
			private function authenticationHandler( event:ChatEvent ):void
			{
				chatController.removeEventListener( ChatEvent.AUTHENTICATION, authenticationHandler );

				currentState = "normal";
				accountChanged=false;
				
				if( chatController.authenticated )
				{
					preferenceController.userAccount = userAccount;
					close();
				}
				else
				{
					Alert.show( "Wrong username or password", "Unable to authenticate", mx.controls.Alert.OK, mainGroup );
				}
			}
			
			
		]]>
	</fx:Script>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
	</fx:Declarations>
	
	<s:states>
		<s:State name="normal" />
		<s:State name="disabled" />
	</s:states>

	
	<s:VGroup id="mainGroup" horizontalCenter="0" verticalCenter="0" enabled="true" enabled.disabled="false" >
		<s:HGroup horizontalAlign="center" verticalAlign="middle" width="100%" height="30">
			<s:Label text="Account settings" fontSize="16" fontWeight="bold"/>
		</s:HGroup>
		
		<s:HGroup verticalAlign="middle" width="100%">
			<s:Label width="100" text="{resourceManager.getString('airim', 'preferenceSocialNetwork' )}" fontWeight="bold" />
			<s:ComboBox id="socialNetworkInput" width="100%"
						dataProvider="{new ArrayCollection(['Twitter','Foursquare'])}" 
						selectedItem="{userAccount.socialNetwork}"
						change="accountChanged=true"
			/>
		</s:HGroup>
		
		<s:HGroup verticalAlign="middle" width="100%">
			<s:Label width="100" text="{resourceManager.getString('airim', 'preferenceUsername' )}" fontWeight="bold" />
			<s:TextInput id="usernameInput" width="100%" text="{userAccount.username}" change="accountChanged=true" />
		</s:HGroup>
		
		
		<s:HGroup verticalAlign="middle" width="100%">
			<s:Label width="100"  text="{resourceManager.getString('airim', 'preferencePassword')}" fontWeight="bold"/>
			<s:TextInput id="passwordInput"  width="100%" displayAsPassword="true" 
						 text="{userAccount.password}" 
						 change="accountChanged=true"
						 enter="saveHandler( event )"/>
		</s:HGroup>

		<s:HGroup verticalAlign="middle" width="100%">
			<s:Label width="100"  text="{resourceManager.getString('airim', 'preferenceStartAtLogin')}" fontWeight="bold"/>
			<s:CheckBox id="startAtLoginInput" selected="{userPreference.startAtLogin}"  />
		</s:HGroup>
		
		<s:HGroup verticalAlign="middle" width="100%">
			<s:Group width="100"/>
			<s:Button label="Save" click="saveHandler( event )" />
		</s:HGroup>
		
		
	</s:VGroup>
	
</s:Window>
